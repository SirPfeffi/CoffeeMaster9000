{% extends "layout.html" %}
{% block content %}
<h2>{{ tr('backup.title') }}</h2>

{% if no_success_24h %}
<p class="danger">{{ tr('backup.no_success_24h') }}</p>
{% endif %}

<form method="post" action="{{ url_for('backup_run') }}">
    <button type="submit">{{ tr('backup.run_now') }}</button>
</form>

<h3>{{ tr('backup.files') }}</h3>
<table>
    <tr>
        <th>Ziel</th>
        <th>Datei</th>
        <th>Geaendert</th>
        <th>Groesse (Bytes)</th>
        <th>Aktionen</th>
    </tr>
    {% for item in backup_files %}
    <tr>
        <td>{{ item.target }}</td>
        <td>{{ item.name }}</td>
        <td>{{ item.modified_at.strftime("%d.%m.%Y %H:%M:%S") }}</td>
        <td>{{ item.size_bytes }}</td>
        <td>
            <form method="post" action="{{ url_for('backup_preview') }}" style="display:inline;">
                <input type="hidden" name="backup_path" value="{{ item.path }}">
                <button type="submit">{{ tr('backup.preview') }}</button>
            </form>
        </td>
    </tr>
    {% endfor %}
</table>

{% if restore_preview %}
<h3>{{ tr('backup.preview') }}</h3>
<p>Datei: {{ restore_preview.backup_path }}</p>
<p>Benutzer: {{ restore_preview.users }}</p>
<p>Transaktionen: {{ restore_preview.transactions }}</p>
<p>Letzte Transaktion: {{ restore_preview.newest_transaction_timestamp }}</p>
<p>Aktuelle DB-Groesse: {{ restore_preview.current_db_size_bytes }} Bytes</p>
<p>Backup-DB-Groesse: {{ restore_preview.backup_db_size_bytes }} Bytes</p>
<form method="post" action="{{ url_for('backup_restore') }}">
    <input type="hidden" name="backup_path" value="{{ restore_preview.backup_path }}">
    <input type="hidden" name="confirm_restore" value="yes">
    <button type="submit">{{ tr('backup.confirm_restore') }}</button>
</form>
{% endif %}

<h3>{{ tr('backup.runs') }}</h3>
<table>
    <tr>
        <th>Zeit</th>
        <th>Ziel</th>
        <th>Status</th>
        <th>Retries</th>
        <th>Details</th>
    </tr>
    {% for run in backup_runs %}
    <tr>
        <td>{{ run.created_at.strftime("%d.%m.%Y %H:%M:%S") }}</td>
        <td>{{ run.target }}</td>
        <td>{{ run.status }}</td>
        <td>{{ run.retries }}</td>
        <td>{{ run.details }}</td>
    </tr>
    {% endfor %}
</table>
{% endblock %}
